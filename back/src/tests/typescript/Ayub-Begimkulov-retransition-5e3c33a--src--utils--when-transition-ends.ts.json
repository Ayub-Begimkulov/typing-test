{"type":"typescript","text":"import { AnyObject } from \"../types\";\n\nconst ANIMATION = \"animation\";\nconst TRANSITION = \"transition\";\n\nexport type CSSTransitionType = typeof ANIMATION | typeof TRANSITION;\n\nexport function whenTransitionEnds(\n  el: Element,\n  cb: () => void,\n  expectedType?: CSSTransitionType\n) {\n  const { type, timeout, propCount } = getTransitionInfo(el, expectedType);\n\n  if (!type) {\n    return cb();\n  }\n\n  const endEvent = type + \"end\";\n  let ended = 0;\n  const end = () => {\n    el.removeEventListener(endEvent, onEnd);\n    cb();\n  };\n  const onEnd = (e: Event) => {\n    if (e.target === el) {\n      if (++ended >= propCount) {\n        end();\n      }\n    }\n  };\n  setTimeout(() => {\n    if (ended < propCount) {\n      end();\n    }\n  }, timeout + 1);\n  el.addEventListener(endEvent, onEnd);\n}\n\ninterface CSSTransitionInfo {\n  type: CSSTransitionType | null;\n  propCount: number;\n  timeout: number;\n  hasTransform: boolean;\n}\n\nexport function getTransitionInfo(\n  el: Element,\n  expectedType?: CSSTransitionType\n): CSSTransitionInfo {\n  const styles: AnyObject = window.getComputedStyle(el);\n  // JSDOM may return undefined for transition properties\n  const getStyleProperties = (key: string) => (styles[key] || \"\").split(\", \");\n  const transitionDelays = getStyleProperties(TRANSITION + \"Delay\");\n  const transitionDurations = getStyleProperties(TRANSITION + \"Duration\");\n  const transitionTimeout = getTimeout(transitionDelays, transitionDurations);\n  const animationDelays = getStyleProperties(ANIMATION + \"Delay\");\n  const animationDurations = getStyleProperties(ANIMATION + \"Duration\");\n  const animationTimeout = getTimeout(animationDelays, animationDurations);\n\n  let type: CSSTransitionInfo[\"type\"] = null;\n  let timeout = 0;\n  let propCount = 0;\n\n  if (expectedType === TRANSITION) {\n    if (transitionTimeout > 0) {\n      type = TRANSITION;\n      timeout = transitionTimeout;\n      propCount = transitionDurations.length;\n    }\n  } else if (expectedType === ANIMATION) {\n    if (animationTimeout > 0) {\n      type = ANIMATION;\n      timeout = animationTimeout;\n      propCount = animationDurations.length;\n    }\n  } else {\n    timeout = Math.max(transitionTimeout, animationTimeout);\n    type =\n      timeout > 0\n        ? transitionTimeout > animationTimeout\n          ? TRANSITION\n          : ANIMATION\n        : null;\n    propCount = type\n      ? type === TRANSITION\n        ? transitionDurations.length\n        : animationDurations.length\n      : 0;\n  }\n  const hasTransform =\n    type === TRANSITION &&\n    /\\b(transform|all)(,|$)/.test(styles[TRANSITION + \"Property\"]);\n  return {\n    type,\n    timeout,\n    propCount,\n    hasTransform,\n  };\n}\n\nfunction getTimeout(delays: string[], durations: string[]): number {\n  while (delays.length < durations.length) {\n    delays = delays.concat(delays);\n  }\n  return Math.max.apply(\n    Math,\n    durations.map((d, i) => toMs(d) + toMs(delays[i]))\n  );\n}\n\n// Old versions of Chromium (below 61.0.3163.100) formats floating pointer\n// numbers in a locale-dependent way, using a comma instead of a dot.\n// If comma is not replaced with a dot, the input will be rounded down\n// (i.e. acting as a floor function) causing unexpected behaviors\nfunction toMs(s: string): number {\n  return Number(s.slice(0, -1).replace(\",\", \".\")) * 1000;\n}","words":[{"text":"import","type":"Keyword","range":[0,6]},{"text":"AnyObject","type":"Identifier","range":[9,18]},{"text":"from","type":"Identifier","range":[21,25]},{"text":"\"../types\"","type":"String","range":[26,36]},{"text":"const","type":"Keyword","range":[39,44]},{"text":"ANIMATION","type":"Identifier","range":[45,54]},{"text":"\"animation\"","type":"String","range":[57,68]},{"text":"const","type":"Keyword","range":[70,75]},{"text":"TRANSITION","type":"Identifier","range":[76,86]},{"text":"\"transition\"","type":"String","range":[89,101]},{"text":"export","type":"Keyword","range":[104,110]},{"text":"type","type":"Identifier","range":[111,115]},{"text":"CSSTransitionType","type":"Identifier","range":[116,133]},{"text":"typeof","type":"Keyword","range":[136,142]},{"text":"ANIMATION","type":"Identifier","range":[143,152]},{"text":"typeof","type":"Keyword","range":[155,161]},{"text":"TRANSITION","type":"Identifier","range":[162,172]},{"text":"export","type":"Keyword","range":[175,181]},{"text":"function","type":"Keyword","range":[182,190]},{"text":"whenTransitionEnds","type":"Identifier","range":[191,209]},{"text":"el","type":"Identifier","range":[213,215]},{"text":"Element","type":"Identifier","range":[217,224]},{"text":"cb","type":"Identifier","range":[228,230]},{"text":"void","type":"Keyword","range":[238,242]},{"text":"expectedType","type":"Identifier","range":[246,258]},{"text":"CSSTransitionType","type":"Identifier","range":[261,278]},{"text":"const","type":"Keyword","range":[285,290]},{"text":"type","type":"Identifier","range":[293,297]},{"text":"timeout","type":"Identifier","range":[299,306]},{"text":"propCount","type":"Identifier","range":[308,317]},{"text":"getTransitionInfo","type":"Identifier","range":[322,339]},{"text":"el","type":"Identifier","range":[340,342]},{"text":"expectedType","type":"Identifier","range":[344,356]},{"text":"if","type":"Keyword","range":[362,364]},{"text":"type","type":"Identifier","range":[367,371]},{"text":"return","type":"Keyword","range":[379,385]},{"text":"cb","type":"Identifier","range":[386,388]},{"text":"const","type":"Keyword","range":[399,404]},{"text":"endEvent","type":"Identifier","range":[405,413]},{"text":"type","type":"Identifier","range":[416,420]},{"text":"\"end\"","type":"String","range":[423,428]},{"text":"let","type":"Keyword","range":[432,435]},{"text":"ended","type":"Identifier","range":[436,441]},{"text":"0","type":"Numeric","range":[444,445]},{"text":"const","type":"Keyword","range":[449,454]},{"text":"end","type":"Identifier","range":[455,458]},{"text":"el","type":"Identifier","range":[473,475]},{"text":"removeEventListener","type":"Identifier","range":[476,495]},{"text":"endEvent","type":"Identifier","range":[496,504]},{"text":"onEnd","type":"Identifier","range":[506,511]},{"text":"cb","type":"Identifier","range":[518,520]},{"text":"const","type":"Keyword","range":[531,536]},{"text":"onEnd","type":"Identifier","range":[537,542]},{"text":"e","type":"Identifier","range":[546,547]},{"text":"Event","type":"Identifier","range":[549,554]},{"text":"if","type":"Keyword","range":[565,567]},{"text":"e","type":"Identifier","range":[569,570]},{"text":"target","type":"Identifier","range":[571,577]},{"text":"el","type":"Identifier","range":[582,584]},{"text":"if","type":"Keyword","range":[594,596]},{"text":"ended","type":"Identifier","range":[600,605]},{"text":"propCount","type":"Identifier","range":[609,618]},{"text":"end","type":"Identifier","range":[630,633]},{"text":"setTimeout","type":"Identifier","range":[658,668]},{"text":"if","type":"Keyword","range":[681,683]},{"text":"ended","type":"Identifier","range":[685,690]},{"text":"propCount","type":"Identifier","range":[693,702]},{"text":"end","type":"Identifier","range":[712,715]},{"text":"timeout","type":"Identifier","range":[730,737]},{"text":"1","type":"Numeric","range":[740,741]},{"text":"el","type":"Identifier","range":[746,748]},{"text":"addEventListener","type":"Identifier","range":[749,765]},{"text":"endEvent","type":"Identifier","range":[766,774]},{"text":"onEnd","type":"Identifier","range":[776,781]},{"text":"interface","type":"Keyword","range":[787,796]},{"text":"CSSTransitionInfo","type":"Identifier","range":[797,814]},{"text":"type","type":"Identifier","range":[819,823]},{"text":"CSSTransitionType","type":"Identifier","range":[825,842]},{"text":"null","type":"Keyword","range":[845,849]},{"text":"propCount","type":"Identifier","range":[853,862]},{"text":"number","type":"Identifier","range":[864,870]},{"text":"timeout","type":"Identifier","range":[874,881]},{"text":"number","type":"Identifier","range":[883,889]},{"text":"hasTransform","type":"Identifier","range":[893,905]},{"text":"boolean","type":"Identifier","range":[907,914]},{"text":"export","type":"Keyword","range":[919,925]},{"text":"function","type":"Keyword","range":[926,934]},{"text":"getTransitionInfo","type":"Identifier","range":[935,952]},{"text":"el","type":"Identifier","range":[956,958]},{"text":"Element","type":"Identifier","range":[960,967]},{"text":"expectedType","type":"Identifier","range":[971,983]},{"text":"CSSTransitionType","type":"Identifier","range":[986,1003]},{"text":"CSSTransitionInfo","type":"Identifier","range":[1007,1024]},{"text":"const","type":"Keyword","range":[1029,1034]},{"text":"styles","type":"Identifier","range":[1035,1041]},{"text":"AnyObject","type":"Identifier","range":[1043,1052]},{"text":"window","type":"Identifier","range":[1055,1061]},{"text":"getComputedStyle","type":"Identifier","range":[1062,1078]},{"text":"el","type":"Identifier","range":[1079,1081]},{"text":" JSDOM may return undefined for transition properties","type":"Line","range":[1086,1141]},{"text":"const","type":"Keyword","range":[1144,1149]},{"text":"getStyleProperties","type":"Identifier","range":[1150,1168]},{"text":"key","type":"Identifier","range":[1172,1175]},{"text":"string","type":"Identifier","range":[1177,1183]},{"text":"styles","type":"Identifier","range":[1189,1195]},{"text":"key","type":"Identifier","range":[1196,1199]},{"text":"\"\"","type":"String","range":[1204,1206]},{"text":"split","type":"Identifier","range":[1208,1213]},{"text":"\", \"","type":"String","range":[1214,1218]},{"text":"const","type":"Keyword","range":[1223,1228]},{"text":"transitionDelays","type":"Identifier","range":[1229,1245]},{"text":"getStyleProperties","type":"Identifier","range":[1248,1266]},{"text":"TRANSITION","type":"Identifier","range":[1267,1277]},{"text":"\"Delay\"","type":"String","range":[1280,1287]},{"text":"const","type":"Keyword","range":[1292,1297]},{"text":"transitionDurations","type":"Identifier","range":[1298,1317]},{"text":"getStyleProperties","type":"Identifier","range":[1320,1338]},{"text":"TRANSITION","type":"Identifier","range":[1339,1349]},{"text":"\"Duration\"","type":"String","range":[1352,1362]},{"text":"const","type":"Keyword","range":[1367,1372]},{"text":"transitionTimeout","type":"Identifier","range":[1373,1390]},{"text":"getTimeout","type":"Identifier","range":[1393,1403]},{"text":"transitionDelays","type":"Identifier","range":[1404,1420]},{"text":"transitionDurations","type":"Identifier","range":[1422,1441]},{"text":"const","type":"Keyword","range":[1446,1451]},{"text":"animationDelays","type":"Identifier","range":[1452,1467]},{"text":"getStyleProperties","type":"Identifier","range":[1470,1488]},{"text":"ANIMATION","type":"Identifier","range":[1489,1498]},{"text":"\"Delay\"","type":"String","range":[1501,1508]},{"text":"const","type":"Keyword","range":[1513,1518]},{"text":"animationDurations","type":"Identifier","range":[1519,1537]},{"text":"getStyleProperties","type":"Identifier","range":[1540,1558]},{"text":"ANIMATION","type":"Identifier","range":[1559,1568]},{"text":"\"Duration\"","type":"String","range":[1571,1581]},{"text":"const","type":"Keyword","range":[1586,1591]},{"text":"animationTimeout","type":"Identifier","range":[1592,1608]},{"text":"getTimeout","type":"Identifier","range":[1611,1621]},{"text":"animationDelays","type":"Identifier","range":[1622,1637]},{"text":"animationDurations","type":"Identifier","range":[1639,1657]},{"text":"let","type":"Keyword","range":[1663,1666]},{"text":"type","type":"Identifier","range":[1667,1671]},{"text":"CSSTransitionInfo","type":"Identifier","range":[1673,1690]},{"text":"\"type\"","type":"String","range":[1691,1697]},{"text":"null","type":"Keyword","range":[1701,1705]},{"text":"let","type":"Keyword","range":[1709,1712]},{"text":"timeout","type":"Identifier","range":[1713,1720]},{"text":"0","type":"Numeric","range":[1723,1724]},{"text":"let","type":"Keyword","range":[1728,1731]},{"text":"propCount","type":"Identifier","range":[1732,1741]},{"text":"0","type":"Numeric","range":[1744,1745]},{"text":"if","type":"Keyword","range":[1750,1752]},{"text":"expectedType","type":"Identifier","range":[1754,1766]},{"text":"TRANSITION","type":"Identifier","range":[1771,1781]},{"text":"if","type":"Keyword","range":[1789,1791]},{"text":"transitionTimeout","type":"Identifier","range":[1793,1810]},{"text":"0","type":"Numeric","range":[1813,1814]},{"text":"type","type":"Identifier","range":[1824,1828]},{"text":"TRANSITION","type":"Identifier","range":[1831,1841]},{"text":"timeout","type":"Identifier","range":[1849,1856]},{"text":"transitionTimeout","type":"Identifier","range":[1859,1876]},{"text":"propCount","type":"Identifier","range":[1884,1893]},{"text":"transitionDurations","type":"Identifier","range":[1896,1915]},{"text":"length","type":"Identifier","range":[1916,1922]},{"text":"else","type":"Keyword","range":[1934,1938]},{"text":"if","type":"Keyword","range":[1939,1941]},{"text":"expectedType","type":"Identifier","range":[1943,1955]},{"text":"ANIMATION","type":"Identifier","range":[1960,1969]},{"text":"if","type":"Keyword","range":[1977,1979]},{"text":"animationTimeout","type":"Identifier","range":[1981,1997]},{"text":"0","type":"Numeric","range":[2000,2001]},{"text":"type","type":"Identifier","range":[2011,2015]},{"text":"ANIMATION","type":"Identifier","range":[2018,2027]},{"text":"timeout","type":"Identifier","range":[2035,2042]},{"text":"animationTimeout","type":"Identifier","range":[2045,2061]},{"text":"propCount","type":"Identifier","range":[2069,2078]},{"text":"animationDurations","type":"Identifier","range":[2081,2099]},{"text":"length","type":"Identifier","range":[2100,2106]},{"text":"else","type":"Keyword","range":[2118,2122]},{"text":"timeout","type":"Identifier","range":[2129,2136]},{"text":"Math","type":"Identifier","range":[2139,2143]},{"text":"max","type":"Identifier","range":[2144,2147]},{"text":"transitionTimeout","type":"Identifier","range":[2148,2165]},{"text":"animationTimeout","type":"Identifier","range":[2167,2183]},{"text":"type","type":"Identifier","range":[2190,2194]},{"text":"timeout","type":"Identifier","range":[2203,2210]},{"text":"0","type":"Numeric","range":[2213,2214]},{"text":"transitionTimeout","type":"Identifier","range":[2225,2242]},{"text":"animationTimeout","type":"Identifier","range":[2245,2261]},{"text":"TRANSITION","type":"Identifier","range":[2274,2284]},{"text":"ANIMATION","type":"Identifier","range":[2297,2306]},{"text":"null","type":"Keyword","range":[2317,2321]},{"text":"propCount","type":"Identifier","range":[2327,2336]},{"text":"type","type":"Identifier","range":[2339,2343]},{"text":"type","type":"Identifier","range":[2352,2356]},{"text":"TRANSITION","type":"Identifier","range":[2361,2371]},{"text":"transitionDurations","type":"Identifier","range":[2382,2401]},{"text":"length","type":"Identifier","range":[2402,2408]},{"text":"animationDurations","type":"Identifier","range":[2419,2437]},{"text":"length","type":"Identifier","range":[2438,2444]},{"text":"0","type":"Numeric","range":[2453,2454]},{"text":"const","type":"Keyword","range":[2462,2467]},{"text":"hasTransform","type":"Identifier","range":[2468,2480]},{"text":"type","type":"Identifier","range":[2487,2491]},{"text":"TRANSITION","type":"Identifier","range":[2496,2506]},{"text":"/\\b(transform|all)(,|$)/","type":"RegularExpression","range":[2514,2538]},{"text":"test","type":"Identifier","range":[2539,2543]},{"text":"styles","type":"Identifier","range":[2544,2550]},{"text":"TRANSITION","type":"Identifier","range":[2551,2561]},{"text":"\"Property\"","type":"String","range":[2564,2574]},{"text":"return","type":"Keyword","range":[2580,2586]},{"text":"type","type":"Identifier","range":[2593,2597]},{"text":"timeout","type":"Identifier","range":[2603,2610]},{"text":"propCount","type":"Identifier","range":[2616,2625]},{"text":"hasTransform","type":"Identifier","range":[2631,2643]},{"text":"function","type":"Keyword","range":[2653,2661]},{"text":"getTimeout","type":"Identifier","range":[2662,2672]},{"text":"delays","type":"Identifier","range":[2673,2679]},{"text":"string","type":"Identifier","range":[2681,2687]},{"text":"durations","type":"Identifier","range":[2691,2700]},{"text":"string","type":"Identifier","range":[2702,2708]},{"text":"number","type":"Identifier","range":[2713,2719]},{"text":"while","type":"Keyword","range":[2724,2729]},{"text":"delays","type":"Identifier","range":[2731,2737]},{"text":"length","type":"Identifier","range":[2738,2744]},{"text":"durations","type":"Identifier","range":[2747,2756]},{"text":"length","type":"Identifier","range":[2757,2763]},{"text":"delays","type":"Identifier","range":[2771,2777]},{"text":"delays","type":"Identifier","range":[2780,2786]},{"text":"concat","type":"Identifier","range":[2787,2793]},{"text":"delays","type":"Identifier","range":[2794,2800]},{"text":"return","type":"Keyword","range":[2809,2815]},{"text":"Math","type":"Identifier","range":[2816,2820]},{"text":"max","type":"Identifier","range":[2821,2824]},{"text":"apply","type":"Identifier","range":[2825,2830]},{"text":"Math","type":"Identifier","range":[2836,2840]},{"text":"durations","type":"Identifier","range":[2846,2855]},{"text":"map","type":"Identifier","range":[2856,2859]},{"text":"d","type":"Identifier","range":[2861,2862]},{"text":"i","type":"Identifier","range":[2864,2865]},{"text":"toMs","type":"Identifier","range":[2870,2874]},{"text":"d","type":"Identifier","range":[2875,2876]},{"text":"toMs","type":"Identifier","range":[2880,2884]},{"text":"delays","type":"Identifier","range":[2885,2891]},{"text":"i","type":"Identifier","range":[2892,2893]},{"text":" Old versions of Chromium (below 61.0.3163.100) formats floating pointer","type":"Line","range":[2905,2979]},{"text":" numbers in a locale-dependent way, using a comma instead of a dot.","type":"Line","range":[2980,3049]},{"text":" If comma is not replaced with a dot, the input will be rounded down","type":"Line","range":[3050,3120]},{"text":" (i.e. acting as a floor function) causing unexpected behaviors","type":"Line","range":[3121,3186]},{"text":"function","type":"Keyword","range":[3187,3195]},{"text":"toMs","type":"Identifier","range":[3196,3200]},{"text":"s","type":"Identifier","range":[3201,3202]},{"text":"string","type":"Identifier","range":[3204,3210]},{"text":"number","type":"Identifier","range":[3213,3219]},{"text":"return","type":"Keyword","range":[3224,3230]},{"text":"Number","type":"Identifier","range":[3231,3237]},{"text":"s","type":"Identifier","range":[3238,3239]},{"text":"slice","type":"Identifier","range":[3240,3245]},{"text":"0","type":"Numeric","range":[3246,3247]},{"text":"1","type":"Numeric","range":[3250,3251]},{"text":"replace","type":"Identifier","range":[3253,3260]},{"text":"\",\"","type":"String","range":[3261,3264]},{"text":"\".\"","type":"String","range":[3266,3269]},{"text":"1000","type":"Numeric","range":[3274,3278]}]}